<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta CNPJ Autom√°tica - Receita Federal</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }

        h1 {
            color: #2d3748;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #4a5568;
        }

        .progress-step:last-child {
            margin-bottom: 0;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }

        .check {
            width: 16px;
            height: 16px;
            background: #48bb78;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .captcha-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .captcha-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .captcha-image {
            max-width: 100%;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .success {
            text-align: center;
            padding: 20px;
            background: #f0fdf4;
            border-radius: 10px;
            border-left: 4px solid #48bb78;
            margin-top: 20px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .error {
            text-align: center;
            padding: 20px;
            background: #fef2f2;
            border-radius: 10px;
            border-left: 4px solid #ef4444;
            margin-top: 20px;
            color: #991b1b;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // IMPORTANTE: Substitua pela URL do seu backend no Render
        const API_URL = 'https://cnpj-backend.onrender.com'; // Mude para a URL do Render em produ√ß√£o

        function App() {
            const [cnpj, setCnpj] = useState('');
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState([]);
            const [showCaptcha, setShowCaptcha] = useState(false);
            const [captchaImage, setCaptchaImage] = useState('');
            const [success, setSuccess] = useState(false);
            const [error, setError] = useState('');

            const formatCNPJ = (value) => {
                const numbers = value.replace(/\D/g, '');
                if (numbers.length <= 14) {
                    return numbers.replace(
                        /(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,
                        '$1.$2.$3/$4-$5'
                    );
                }
                return numbers.slice(0, 14);
            };

            const addProgress = (message) => {
                setProgress(prev => [...prev, { message, timestamp: Date.now() }]);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setProgress([]);
                setSuccess(false);
                setError('');

                try {
                    addProgress('Conectando √† Receita Federal...');
                    
                    const response = await fetch(`${API_URL}/api/consult`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ cnpj: cnpj.replace(/\D/g, '') }),
                    });

                    if (response.status === 200) {
                        addProgress('Captcha resolvido!');
                        addProgress('Extraindo dados do Cart√£o CNPJ...');
                        addProgress('Gerando PDF do Cart√£o CNPJ...');
                        addProgress('Acessando p√°gina do QSA...');
                        addProgress('Gerando PDF do QSA...');
                        addProgress('Criando pasta com nome da empresa...');
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'consulta_cnpj.zip';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);

                        addProgress('Download conclu√≠do!');
                        setSuccess(true);
                    } else {
                        const data = await response.json();
                        
                        if (data.status === 'captcha_required') {
                            addProgress('Captcha detectado. Por favor, resolva...');
                            setCaptchaImage(data.captcha_image);
                            setShowCaptcha(true);
                        } else {
                            setError(data.error || 'Erro desconhecido');
                        }
                    }
                } catch (err) {
                    setError('Erro ao conectar com o servidor. Verifique se o backend est√° rodando.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <div className="logo">üìã</div>
                        <h1>Consulta CNPJ Autom√°tica</h1>
                        <p className="subtitle">Receita Federal do Brasil</p>
                    </div>

                    <div className="info-box">
                        ‚ÑπÔ∏è Digite o CNPJ e deixe o sistema fazer o resto! Os PDFs ser√£o baixados automaticamente.
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label htmlFor="cnpj">CNPJ da Empresa</label>
                            <input
                                type="text"
                                id="cnpj"
                                placeholder="00.000.000/0000-00"
                                value={cnpj}
                                onChange={(e) => setCnpj(formatCNPJ(e.target.value))}
                                maxLength="18"
                                required
                            />
                        </div>

                        <button type="submit" className="btn" disabled={loading || cnpj.length < 18}>
                            {loading ? 'Consultando...' : 'Iniciar Consulta'}
                        </button>
                    </form>

                    {progress.length > 0 && (
                        <div className="progress">
                            {progress.map((item, index) => (
                                <div key={index} className="progress-step">
                                    {index === progress.length - 1 && loading ? (
                                        <div className="spinner"></div>
                                    ) : (
                                        <div className="check">‚úì</div>
                                    )}
                                    {item.message}
                                </div>
                            ))}
                        </div>
                    )}

                    {success && (
                        <div className="success">
                            <div className="success-icon">‚úÖ</div>
                            <strong>Consulta conclu√≠da com sucesso!</strong>
                            <p>Os arquivos foram baixados para seu computador.</p>
                        </div>
                    )}

                    {error && (
                        <div className="error">
                            <strong>‚ö†Ô∏è Erro</strong>
                            <p>{error}</p>
                        </div>
                    )}

                    {showCaptcha && (
                        <div className="captcha-modal">
                            <div className="captcha-content">
                                <h2>Resolva o Captcha</h2>
                                <p>Por favor, resolva o captcha no site da Receita Federal</p>
                                <img 
                                    src={`data:image/png;base64,${captchaImage}`} 
                                    alt="Captcha" 
                                    className="captcha-image"
                                />
                                <button 
                                    className="btn" 
                                    onClick={() => setShowCaptcha(false)}
                                >
                                    Continuar
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
